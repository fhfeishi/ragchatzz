<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RAG 智能体对话</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9fb;
      height: 100vh;
      display: flex;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      border: 1px solid #ddd;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    /* 侧边栏 */
    .sidebar {
      width: 280px;
      background-color: #f3f4f6;
      border-right: 1px solid #ddd;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .sidebar-header h3 {
      font-size: 18px;
      color: #333;
    }

    .new-chat-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .chat-list {
      list-style: none;
      flex: 1;
      overflow-y: auto;
    }

    .chat-item {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    .chat-item:hover { background-color: #e9ecef; }
    .chat-item.active { background-color: #d0ebff; font-weight: 600; }

    /* 主内容区 */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #fff;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-end;
      background-color: #007bff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      align-self: flex-start;
      background-color: #f1f1f1;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    /* 头像和消息容器 */
    .message-container {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .avatar.loading img {
      animation: spin 1.5s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* 输入区域 */
    .input-area {
      padding: 15px;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 10px;
    }

    .input-area textarea {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: none;
      outline: none;
      font-size: 16px;
      line-height: 1.4;
    }

    .input-area button {
      padding: 0 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    /* 参考资料样式 */
    .references {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px dashed #ccc;
      font-size: 0.9em;
      color: #555;
    }

    .references img {
      max-width: 200px;
      border-radius: 6px;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<div class="app-container">
  <!-- 左侧历史会话 -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h3>对话历史</h3>
      <button id="new-chat" class="new-chat-btn">➕ 新建</button>
    </div>
    <ul id="chat-list" class="chat-list">
      <li class="chat-item active">今天的问答</li>
      <li class="chat-item">产品文档查询</li>
    </ul>
  </aside>

  <!-- 主聊天区 -->
  <main class="main-content">
    <div id="chat-messages" class="chat-messages">
      <!-- 初始欢迎消息 -->
      <div class="message-container">
        <div class="avatar">
          <img src="bot-avatar.png" alt="Bot" />
        </div>
        <div class="message bot">
          你好！我是本地 RAG 智能助手，请问有什么可以帮助你？
        </div>
      </div>
    </div>

    <!-- 输入区域 -->
    <div class="input-area">
      <textarea id="user-input" placeholder="输入你的问题..." rows="1"></textarea>
      <button id="send-btn">发送</button>
    </div>
  </main>
</div>

<script>
  // DOM 元素
  const chatMessages = document.getElementById('chat-messages');
  const userInput = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const newChatBtn = document.getElementById('new-chat');
  const avatar = document.querySelector('.avatar');

  // 模拟后端响应（你可以替换成 fetch 调用真实接口）
  async function callRagBackend(query) {
    // 模拟延迟
    await new Promise(resolve => setTimeout(resolve, 1500));

    // 模拟返回数据
    return {
      llm_answer: `# 这是关于 "${query}" 的回答

我们找到了相关信息，并附上图示说明。

\`\`\`python
print("Hello from RAG!")
\`\`\`

请查看下方参考资料。`,
      references: [
        {
          infor_a: "技术文档 A",
          im_path: ["系统架构图", "./images/arch.png"]
        },
        {
          infor_a: "流程说明",
          im_path: ["数据流图", "./images/flow.png"]
        }
      ]
    };
  }

  // 添加用户消息
  function addUserMessage(text) {
    const messageEl = document.createElement('div');
    messageEl.className = 'message user';
    messageEl.textContent = text;
    chatMessages.appendChild(messageEl);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // 添加机器人消息（含 Markdown 和 图片）
  function addBotMessage(markdownContent, sources = []) {
    const container = document.createElement('div');
    container.className = 'message-container';

    const avatarEl = document.createElement('div');
    avatarEl.className = 'avatar';
    const img = document.createElement('img');
    img.src = 'bot-avatar.png';
    img.alt = 'Bot';
    avatarEl.appendChild(img);
    container.appendChild(avatarEl);

    const messageEl = document.createElement('div');
    messageEl.className = 'message bot';
    messageEl.innerHTML = marked.parse(markdownContent);

    // 添加参考资料
    if (sources && sources.length > 0) {
      const refDiv = document.createElement('div');
      refDiv.className = 'references';
      refDiv.innerHTML = '<strong>参考资料:</strong>';

      sources.forEach(src => {
        const item = document.createElement('div');
        item.style.marginTop = '8px';

        if (src.im_path && src.im_path.length >= 2) {
          const [desc, imagePath] = src.im_path;
          item.innerHTML = `<div>${desc}</div><img src="${imagePath}" alt="${desc}" />`;
        } else {
          item.textContent = src.infor_a || "未知信息";
        }

        refDiv.appendChild(item);
      });

      messageEl.appendChild(refDiv);
    }

    container.appendChild(messageEl);
    chatMessages.appendChild(container);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // 控制头像动效
  function setBotTyping(loading) {
    if (loading) {
      avatar.classList.add('loading');
    } else {
      avatar.classList.remove('loading');
    }
  }

  // 发送消息
  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    addUserMessage(text);
    userInput.value = '';
    setBotTyping(true);

    try {
      const response = await callRagBackend(text);
      addBotMessage(response.llm_answer, response.references);
    } catch (err) {
      addBotMessage("抱歉，处理请求时出错。");
    } finally {
      setBotTyping(false);
    }
  }

  // 事件监听
  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  newChatBtn.addEventListener('click', () => {
    // 清空对话（实际项目可保存到 localStorage）
    while (chatMessages.children.length > 1) {
      chatMessages.lastChild.remove();
    }
    // 添加新会话到侧栏（模拟）
    const chatList = document.getElementById('chat-list');
    const now = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const newItem = document.createElement('li');
    newItem.className = 'chat-item active';
    newItem.textContent = `新对话 ${now}`;
    chatList.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
    chatList.appendChild(newItem);

    // 发送欢迎消息
    const welcomeMsg = document.createElement('div');
    welcomeMsg.className = 'message-container';
    welcomeMsg.innerHTML = `
      <div class="avatar"><img src="../static/res/shark.png" alt="Bot"/></div>
      <div class="message bot">你好！新对话已开始。</div>
    `;
    chatMessages.appendChild(welcomeMsg);
  });
</script>

</body>
</html>